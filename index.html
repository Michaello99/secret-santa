<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Secret Santa Admin Panel</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
(function(){ emailjs.init("wWENyy67HreppO1b7"); })();
</script>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif; background:#f5f5f7; padding:30px;}
h1{text-align:center;}
textarea, input, select{width:100%; padding:10px; margin:10px 0; border-radius:12px; border:1px solid #d2d2d7;}
button{padding:12px 20px; border:none; border-radius:16px; background:#007aff; color:white; cursor:pointer; margin-top:10px;}
.result{margin-top:20px; font-weight:600;}
label{font-weight:600;}
.restriction-row{display:flex; gap:10px; margin-bottom:10px;}
.restriction-row select{flex:1;}
</style>
</head>
<body>
<h1>üéÑ Sekretny Miko≈Çaj - Panel administratora</h1>

<label>Lista uczestnik√≥w (imiƒô, email)</label>
<textarea id="peopleInput">Ania, ania@gmail.com
Bartek, bartek@gmail.com
Kasia, kasia@gmail.com
Micha≈Ç, michal@gmail.com</textarea>

<h3>Ograniczenia</h3>
<div id="restrictionsContainer"></div>
<button onclick="addRestriction()">Dodaj ograniczenie</button>

<button onclick="drawAndSend()">Losuj i wy≈õlij linki</button>

<div id="output" class="result"></div>

<script>
function shuffle(array){return array.sort(()=>Math.random()-0.5);}
function generateId(){return Math.random().toString(36).substr(2,9);}

function getPeopleNames(){ 
  return peopleInput.value.split("\n").map(l=>{ 
    const p=l.split(","); return p[0].trim(); 
  }).filter(Boolean); 
}

// Dodawanie nowego wiersza ograniczenia
function addRestriction(){
  const container = document.getElementById("restrictionsContainer");
  const row = document.createElement("div");
  row.className = "restriction-row";

  const names = getPeopleNames();

  const selectGiver = document.createElement("select");
  names.forEach(n=>{ const opt=document.createElement("option"); opt.value=n; opt.text=n; selectGiver.appendChild(opt); });

  const selectReceiver = document.createElement("select");
  names.forEach(n=>{ const opt=document.createElement("option"); opt.value=n; opt.text=n; selectReceiver.appendChild(opt); });

  const removeBtn = document.createElement("button");
  removeBtn.textContent = "Usu≈Ñ";
  removeBtn.onclick = ()=>row.remove();

  row.appendChild(selectGiver);
  row.appendChild(selectReceiver);
  row.appendChild(removeBtn);
  container.appendChild(row);
}

// Parsowanie ogranicze≈Ñ z ComboBox
function parseRestrictions(){
  const container = document.getElementById("restrictionsContainer");
  const res = {};
  container.querySelectorAll(".restriction-row").forEach(row=>{
    const giver = row.children[0].value;
    const receiver = row.children[1].value;
    if(!res[giver]) res[giver] = [];
    res[giver].push(receiver);
  });
  return res;
}

async function drawAndSend(){
  const output = document.getElementById("output");
  const people = peopleInput.value.split("\n").map(l=>{ const p=l.split(","); return {name:p[0].trim(), email:p[1].trim()}; }).filter(Boolean);
  const restrictions = parseRestrictions();

  let receivers = [...people];
  let ok=false;
  let pairs=[];
  for(let i=0;i<1000;i++){
    shuffle(receivers); ok=true; pairs=[];
    for(let j=0;j<people.length;j++){
      const giver = people[j].name;
      const receiver = receivers[j].name;
      if(giver===receiver || (restrictions[giver] && restrictions[giver].includes(receiver))){ok=false; break;}
      pairs.push({giver:people[j], receiver:receivers[j], id:generateId()});
    }
    if(ok) break;
  }
  if(!ok){output.innerText="Nie uda≈Ço siƒô wylosowaƒá par z uwzglƒôdnieniem ogranicze≈Ñ."; return;}

  const promises = pairs.map(async p=>{
    // Zapis do Firebase
    await db.collection("pairs").doc(p.id).set({
      giver:p.giver.name,
      giverEmail:p.giver.email,
      receiver:p.receiver.name,
      receiverWishlist:[]
    });

    // Wysy≈Çka maila przez EmailJS
    const templateParams = {
      to_name: p.giver.name,
      to_email: p.giver.email,
      receiver_name: p.receiver.name,
      unique_link: `https://michaello99.github.io/secret-santa/santa.html?id=${p.id}`
    };
    return emailjs.send("service_29vqohf", "template_5tj3h4q", templateParams);
  });

  output.innerText = "Wysy≈Çanie maili...";
  try {
    await Promise.all(promises);
    output.innerText = "‚úÖ Wszystkie maile zosta≈Çy wys≈Çane!";
  } catch(err){
    console.error(err);
    output.innerText = "‚ùå B≈ÇƒÖd podczas wysy≈Çania maili. Sprawd≈∫ konsolƒô.";
  }
}
</script>
</body>
</html>

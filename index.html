<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Secret Santa Admin</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
(function(){ emailjs.init("wWENyy67HreppO1b7"); })();
</script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #f5f5f7;
  padding: 30px;
  transition: background 0.3s;
}
h1 { text-align: center; color: #111; margin-bottom: 20px; }
textarea, select, input {
  width: 100%; padding: 12px; margin: 8px 0;
  border-radius: 14px; border: 1px solid #d2d2d7; background: #fff; font-size: 16px; transition: all 0.3s ease;
}
textarea:focus, select:focus, input:focus {
  outline: none; border-color: #007aff; box-shadow: 0 0 8px rgba(0,122,255,0.3);
}
button {
  padding: 12px 24px; border: none; border-radius: 16px;
  background: #007aff; color: white; font-weight: 600; cursor: pointer;
  transition: all 0.25s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
button:hover { background: #005ecb; transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.15); }
.result { margin-top: 20px; font-weight: 600; color: #333; min-height: 24px; transition: color 0.3s; }
label { font-weight:600; display:block; margin-top:10px; color:#333; }
.restriction-row { display:flex; gap:10px; margin-bottom:10px; opacity:0; transform:translateY(-10px); animation:fadeIn 0.3s forwards; }
.restriction-row select { flex:1; }
@keyframes fadeIn { to { opacity:1; transform:translateY(0); } }
</style>
</head>
<body>

<h1>üéÑ Secret Santa Admin</h1>

<label>Lista uczestnik√≥w (imiƒô, email)</label>
<textarea id="peopleInput">Ania, ania@gmail.com
Bartek, bartek@gmail.com
Kasia, kasia@gmail.com
Micha≈Ç, michal@gmail.com</textarea>

<h3>Ograniczenia</h3>
<div id="restrictionsContainer"></div>
<button id="addRestrictionBtn">‚ûï Dodaj ograniczenie</button>

<button id="drawSendBtn" style="margin-top:20px;">üéÅ Losuj i wy≈õlij linki</button>

<div id="output" class="result"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const peopleInput = document.getElementById("peopleInput");
  const restrictionsContainer = document.getElementById("restrictionsContainer");
  const output = document.getElementById("output");
  const addRestrictionBtn = document.getElementById("addRestrictionBtn");
  const drawSendBtn = document.getElementById("drawSendBtn");
  const db = firebase.firestore();

  function shuffle(array){ return array.sort(()=>Math.random()-0.5); }
  function generateId(){ return Math.random().toString(36).substr(2,9); }
  function getPeopleNames(){ return peopleInput.value.split("\n").map(l=>l.split(",")[0].trim()).filter(Boolean); }

  function addRestriction(){
    const row = document.createElement("div");
    row.className="restriction-row";

    const names=getPeopleNames();

    const selectGiver=document.createElement("select");
    names.forEach(n=>{ const opt=document.createElement("option"); opt.value=n; opt.text=n; selectGiver.appendChild(opt); });

    const selectReceiver=document.createElement("select");
    names.forEach(n=>{ const opt=document.createElement("option"); opt.value=n; opt.text=n; selectReceiver.appendChild(opt); });

    const removeBtn=document.createElement("button");
    removeBtn.textContent="üóë Usu≈Ñ";
    removeBtn.style.background="#ff3b30";
    removeBtn.style.margin="0";
    removeBtn.onclick=()=>{ row.remove(); };

    row.appendChild(selectGiver);
    row.appendChild(selectReceiver);
    row.appendChild(removeBtn);
    restrictionsContainer.appendChild(row);
  }

  function parseRestrictions(){
    const res = {};
    restrictionsContainer.querySelectorAll(".restriction-row").forEach(row=>{
      const giver=row.children[0].value;
      const receiver=row.children[1].value;
      if(!res[giver]) res[giver]=[];
      res[giver].push(receiver);
    });
    return res;
  }

  async function drawAndSend(){
    const people = peopleInput.value.split("\n").map(l=>{ const p=l.split(","); return {name:p[0].trim(), email:p[1].trim()}; }).filter(Boolean);
    const restrictions = parseRestrictions();
    let receivers = [...people];
    let ok = false;
    let pairs = [];

    for(let i=0;i<1000;i++){
      shuffle(receivers);
      ok=true;
      pairs=[];
      for(let j=0;j<people.length;j++){
        const giver=people[j].name;
        const receiver=receivers[j].name;
        if(giver===receiver || (restrictions[giver] && restrictions[giver].includes(receiver))){ ok=false; break; }
        pairs.push({giver:people[j], receiver:receivers[j], id:generateId()});
      }
      if(ok) break;
    }

    if(!ok){ output.innerText="‚ùå Nie uda≈Ço siƒô wylosowaƒá par."; return; }

    output.innerText="üì® Wysy≈Çanie maili...";
    let success=0, fail=0;

    for(const p of pairs){
      try{
        // Zapis do Firebase
        await db.collection("pairs").doc(p.id).set({
          giver: p.giver.name,
          giverEmail: p.giver.email,
          receiver: p.receiver.name,
          receiverWishlist: [],
          giverWishlist: []
        });

        await emailjs.send("service_29vqohf","template_5tj3h4q",{
          to_name:p.giver.name,
          to_email:p.giver.email,
          receiver_name:p.receiver.name,
          unique_link:`https://michaello99.github.io/secret-santa/santa.html?id=${p.id}`
        });
        success++;
        console.log(`‚úÖ Mail wys≈Çany do ${p.giver.email}`);
      }catch(err){ console.error(err); fail++; }
    }

    output.innerText=`‚úÖ Wysy≈Çka zako≈Ñczona. Sukcesy: ${success}, B≈Çƒôdy: ${fail}`;
  }

  addRestrictionBtn.addEventListener("click", addRestriction);
  drawSendBtn.addEventListener("click", drawAndSend);
});
</script>
</body>
</html>